<?php

namespace App\Filament\Clusters\KhaoSat\Pages;

use App\Filament\Clusters\KhaoSat;
use App\Models\Survey\{Survey, SurveySection, SurveyQuestion};
use Filament\Pages\Page;
use Filament\Forms\Form;
use Filament\Forms\Contracts\HasForms;
use Filament\Forms\Concerns\InteractsWithForms;
use Filament\Notifications\Notification;
use Filament\Forms\Components\{Wizard, Wizard\Step, TextInput, Textarea, Toggle, Repeater, Select};
use Filament\Pages\SubNavigationPosition;
use Filament\Support\Enums\MaxWidth;
use Filament\Forms\Components\Actions\Action;
use Illuminate\Support\Facades\Request;

class CreateSurveyForm extends Page implements HasForms
{
    use InteractsWithForms;

    protected static ?string $navigationIcon = 'heroicon-o-document-text';
    protected static string $view = 'filament.clusters.khao-sat.pages.create-survey-form';
    protected static ?string $title = 'T·∫°o kh·∫£o s√°t';
    protected static ?string $slug = 'create-survey';
    protected static ?string $cluster = KhaoSat::class;
    protected static ?int $navigationSort = 1;
    protected static bool $shouldRegisterNavigation = true;
    protected static SubNavigationPosition $subNavigationPosition = SubNavigationPosition::Top; // Or SubNavigationPosition::Start

    public ?array $data = [];
    public ?int $surveyId = null; // Th√™m bi·∫øn ƒë·ªÉ l∆∞u surveyId n·∫øu c·∫ßn c·∫≠p nh·∫≠t

    public function getMaxContentWidth(): MaxWidth
    {
        return MaxWidth::Full;
    }

    public function mount(): void
    {
        $this->surveyId = request()->query('record'); // üëà L·∫•y record t·ª´ query th·ªß c√¥ng

        if ($this->surveyId) {
            $survey = Survey::with('sections.questions')->findOrFail($this->surveyId); // ‚ö†Ô∏è Kh√¥ng d√πng inject tr·ª±c ti·∫øp n·ªØa

            $this->data = [
                'title' => $survey->title,
                'description' => $survey->description,
                'is_active' => $survey->is_active,
                'sections' => $survey->sections->map(function ($section) {
                    return [
                        'title' => $section->title,
                        'questions' => $section->questions->map(function ($question) {
                            return [
                                'question' => $question->question,
                                'type' => $question->type,
                                'options' => collect(json_decode($question->options ?? '[]'))
                                    ->map(function ($item) {
                                        if (is_object($item) && isset($item->label)) {
                                            return ['label' => $item->label];
                                        }

                                        if (is_array($item) && isset($item['label'])) {
                                            return ['label' => $item['label']];
                                        }

                                        return ['label' => $item]; // fallback n·∫øu ch·ªâ l√† chu·ªói
                                    })
                                    ->toArray(),
                                'is_required' => $question->is_required,
                            ];
                        })->toArray(),
                    ];
                })->toArray(),
            ];
        }

        $this->form->fill($this->data);
    }

    public function form(Form $form): Form
    {
        return $form
            ->schema([
                Wizard::make([
                    Step::make('Th√¥ng tin kh·∫£o s√°t')
                        ->schema([
                            TextInput::make('title')
                                ->label('Ti√™u ƒë·ªÅ kh·∫£o s√°t')
                                ->required(),

                            Textarea::make('description')
                                ->label('M√¥ t·∫£ kh·∫£o s√°t'),

                            Toggle::make('is_active')
                                ->label('ƒêang ho·∫°t ƒë·ªông')
                                ->default(true),
                        ]),

                    Step::make('N·ªôi dung c√¢u h·ªèi')
                        ->schema([
                            Repeater::make('sections')
                                ->label('C√°c ph·∫ßn (section)')
                                ->schema([
                                    TextInput::make('title')
                                        ->label('T√™n ph·∫ßn')
                                        ->required(),

                                    Repeater::make('questions')
                                        ->label('Danh s√°ch c√¢u h·ªèi')
                                        ->schema([
                                            TextInput::make('question')
                                                ->label('N·ªôi dung c√¢u h·ªèi')
                                                ->required(),

                                            Select::make('type')
                                                ->label('Lo·∫°i c√¢u h·ªèi')
                                                // ->options([
                                                //     'text' => 'Text',
                                                //     'textarea' => 'Textarea',
                                                //     'select' => 'Select (dropdown)',
                                                //     'radio' => 'Radio',
                                                //     'checkbox' => 'Checkbox',
                                                //     'rating' => 'Rating (stars)',
                                                // ])
                                                ->options([
                                                    'text' => 'VƒÉn b·∫£n m·ªôt d√≤ng',
                                                    'textarea' => 'VƒÉn b·∫£n nhi·ªÅu d√≤ng',
                                                    'select' => 'Ch·ªçn t·ª´ danh s√°ch',
                                                    'radio' => 'Ch·ªçn m·ªôt ƒë√°p √°n',
                                                    'checkbox' => 'Ch·ªçn nhi·ªÅu ƒë√°p √°n',
                                                    'rating' => 'ƒê√°nh gi√° (ng√¥i sao)',
                                                ])
                                                ->required()
                                                ->reactive(),

                                            Repeater::make('options')
                                                ->label('T√πy ch·ªçn')
                                                ->schema([
                                                    TextInput::make('label')->label('L·ª±a ch·ªçn'),
                                                ])
                                                ->visible(fn($get) => in_array($get('type'), ['select', 'radio', 'checkbox']))
                                                ->defaultItems(2)
                                                ->minItems(1)
                                                ->collapsible(),

                                            Toggle::make('is_required')->label('B·∫Øt bu·ªôc')->default(true),
                                        ])
                                        ->minItems(1)
                                        ->collapsible()
                                        ->reorderable(),
                                ])
                                ->minItems(1)
                                ->collapsible()
                                ->reorderable(),
                        ]),
                ])
                    ->submitAction(
                        Action::make('submit')
                            ->label('T·∫°o kh·∫£o s√°t')
                            ->action('submit')
                            ->color('primary')
                    )
            ])
            ->statePath('data');
    }

    public function submit(): void
    {
        $data = $this->form->getState();

        // N·∫øu c√≥ surveyId => c·∫≠p nh·∫≠t kh·∫£o s√°t c≈©
        if ($this->surveyId) {
            $survey = Survey::findOrFail($this->surveyId);

            // C·∫≠p nh·∫≠t kh·∫£o s√°t
            $survey->update([
                'title' => $data['title'],
                'description' => $data['description'],
                'is_active' => $data['is_active'] ?? true,
            ]);

            // X√≥a d·ªØ li·ªáu c≈©: sections v√† questions
            $survey->sections()->each(function ($section) {
                $section->questions()->delete();
                $section->delete();
            });
        } else {
            // T·∫°o m·ªõi n·∫øu kh√¥ng c√≥ surveyId
            $survey = Survey::create([
                'title' => $data['title'],
                'description' => $data['description'],
                'is_active' => $data['is_active'] ?? true,
            ]);
        }

        // T·∫°o l·∫°i sections v√† questions m·ªõi
        foreach ($data['sections'] as $sectionIndex => $sectionData) {
            $section = SurveySection::create([
                'survey_id' => $survey->id,
                'title' => $sectionData['title'],
                'order' => $sectionIndex + 1,
            ]);

            foreach ($sectionData['questions'] as $questionIndex => $q) {
                SurveyQuestion::create([
                    'section_id' => $section->id,
                    'question' => $q['question'],
                    'type' => $q['type'],
                    'options' => in_array($q['type'], ['select', 'radio', 'checkbox']) ? json_encode($q['options']) : null,
                    'is_required' => $q['is_required'] ?? false,
                    'order' => $questionIndex + 1,
                ]);
            }
        }

        Notification::make()
            ->title($this->surveyId ? 'C·∫≠p nh·∫≠t kh·∫£o s√°t th√†nh c√¥ng' : 'T·∫°o kh·∫£o s√°t th√†nh c√¥ng')
            ->success()
            ->send();

        $this->redirect(CreateSurveyForm::getUrl(['record' => $survey->id]));
    }
}
